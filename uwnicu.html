<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

  <title>NICU rounding</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
    crossorigin="anonymous">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <style>
    <!-- .row-divider {
      margin-bottom: 1em;
    }
    
    .with-rborder {
      border-right: 1px solid #BBB;
    }
    
    .table.table-bordered.table-condensed {
      margin-bottom: 0px;
    }
    
    .table-bordered>tbody>tr>td, .table-bordered>tbody>tr>th, .table-bordered>tfoot>tr>td, .table-bordered>tfoot>tr>th, .table-bordered>thead>tr>td, .table-bordered>thead>tr>th {
      border-color: #888;
    }

    .page-break {
      display: block;
      page-break-before: always;
    }

    @media print {
      body { font-size: 10px; }
      .dont-print, .dont-print * { display: none !important; }
      .row-divider, hr { display: none !important; }
      div   { float: none !important; }
      table { float: none !important; page-break-after:auto }
      tr    { page-break-inside:avoid; page-break-after:auto }
      td    { page-break-inside:avoid; page-break-after:auto }
      thead { display:table-header-group }
      tfoot { display:table-footer-group }
    }
    -->
  </style>

</head>

<body>

  <div class="container-fluid">
    <div class="row dont-print">
      <div class="col-md-4">
        <h6>NICU Report from CORES:</h6>
        <textarea id="nicu-report" class="form-control" rows="2" placeholder="CORES > Print Report > NICU Report > Just Print. Ctrl+A to select all, Ctrl+C to copy. Paste here."></textarea>
      </div>
      <div class="col-md-4">
        <h6>zzTest GenSurg A v2 report from CORES:</h6>
        <textarea id="surg-report" class="form-control" rows="2" placeholder="CORES > Print Report > zzTest GenSurg A v2 > Just Print. Ctrl+A to select all, Ctrl+C to copy. Paste here."></textarea>
      </div>
      <div class="col-md-4">
        <h6>NeoData Report Sheets:</h6>
        <textarea id="neodata-report" class="form-control" rows="2" placeholder="NeoData > File > Print Preview > Report Sheets. Ctrl+A to select all, Ctrl+C to copy. Paste here."></textarea>
      </div>
    </div>
    <div class="row row-divider"></div>
    <div class="row">
      <div class="col-md-12">
        <h6 class="dont-print">Rounding Data <small>(missing total fluids, diaper/stool counts, ABCs, liquid protein, labs other than cbc/chem)</small>:</h6>
        <div id="empty" class="text-muted"><small>Paste rounding reports above to show data.</small></div>
        <div id="processing" class="text-muted" style="display:none;"><small>Processing reports...</small></div>
      </div>
    </div>
    <div id="rounding-data"></div>
    <div class="row row-divider"></div>
  </div>

  <script id="tpl-rounding-table" type="text/template">
    <div class="row"></div>
      <div class="col-xs-12">
        <table class="table table-bordered table-condensed">
          <tbody>
            <tr><th style="width: 1px">Name</th></tr>
            <tr><th>Date</th></tr>
            <tr>
              <th>Age</th>
            </tr>
            <tr>
              <th>Major Events<br>&nbsp;</th>
            </tr>
            <tr>
              <th>Weight &nbsp;&#x25B3;</th>
            </tr>
            <tr>
              <th>
                <u>FEN</u><br>
                <small>
                  TF/<br>
                  UOP Stool
                </small>
              </th>
            </tr>
            <tr>
              <th>Access</th>
            </tr>
            <tr>
              <th>
                Feeds<br><br>
                Lines<br>
                Labs
              </th>
            </tr>
            <tr>
              <th>
                <u>Resp</u> | DX<br>
                Vent Mode
              </th>
            </tr>
            <tr>
              <th>
                <small>
                  Vt/PIP/PEEP<br>
                  Rate PS<br>
                  FiO2,Sats<br>
                </small>
                RR<br>
                Gases<br>
                Resp Rx<br>
                ABC's<br>
              </th>
            </tr>
            <tr>
              <th>
                <u>CV</u> | HR<br>
                S/D if PDA<br>
                Pressors
              </th>
            </tr>
            <tr>
              <th>
                <u>GI</u> | Bili<br>
                PTX
              </th>
            </tr>
            <tr>
              <th>
                <u>Heme</u><br>
                Heme Rx
              </th>
            </tr>
            <tr>
              <th>
                <u>ID</u> | Temp<br>
                Abx
              </th>
            </tr>
            <tr>
              <th>
                <u>Neuro</u><br>
                BIIP<br>
                OFC
              </th>
            </tr>
            <tr>
              <th><u>Other Meds</u></th>
            </tr>
            <tr>
              <th><u>To Do</u><br>&nbsp;</th>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="row row-divider"></div>
  </script>
  <script id="tpl-rounding-col" type="text/template">
    <table>
      <tbody>
        <tr><td style="width: 21%"><%= name %></td></tr>
        <tr><td><%= date %></td></tr>
        <tr>
          <td>
            <div class="row">
              <div class="col-xs-6 with-rborder">
                <%= age %>
              </div>
              <div class="col-xs-6">
                <%= cga %>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <td></td>
        </tr>
        <tr>
          <td>
            <div class="row">
              <div class="col-xs-6 with-rborder">
                <%= weight %>
              </div>
              <div class="col-xs-6">
                <%= weightDiff %>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <div class="row">
              <div class="col-xs-6">
                <table class="table table-bordered table-condensed">
                  <tr><td style="width: 50%"><%= TF %></td><td><%= actual_fluids %></td></tr>
                  <tr><td><%= UOP %></td><td><%= stools %></td></tr>
                </table>
              </div>
              <div class="col-xs-6">
                <small>
                  <%= PO_percent %><br>
                  <%= emesis %>
                </small>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <td></td>
        </tr>
        <tr>
          <td>
            <%= feeds %><br>
            <%= sups %><br>
            <%= chem %><br>
            </td>
        </tr>
        <tr>
          <td><%= resp %></td>
        </tr>
        <tr>
          <td>
            FiO2: <%= fio2 %><br>
            SpO2: <%= spo2 %><br>
            RR: <%= rr %><br>
            <br>
            <%= gases %><br>
            ABCs: <%= ABCs %>
          </td>            
        </tr>
        <tr>
          <td>
            HR: <%= hr %><br>
            MAP: <%= map %>
          </td>
        </tr>
        <tr>
          <td><%= gi %></td>
        </tr>
        <tr>
          <td><%= heme %></td>
        </tr>
        <tr>
          <td>
            T: <%= temp %>
            <%= abx %>
          </td>
        </tr>
        <tr>
          <td><%= neuro %></td>
        </tr>
        <tr>
          <td><%= meds %></td>
        </tr>
        <tr>
          <td></td>
        </tr>
      </tbody>
    </table>
  </script>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/lodash/4.13.1/lodash.min.js" crossorigin="anonymous"></script>
  <script>
    var $nicuReport = $('#nicu-report');
    var $surgReport = $('#surg-report');
    var $neodataReport = $('#neodata-report');
    var $roundingData = $('#rounding-data');
    var $empty = $('#empty');
    var $processing = $('#processing');
    var roundingTableTpl = _.template($('#tpl-rounding-table').html());
    var roundingColTpl = _.template($('#tpl-rounding-col').html());
    var row = function() { return $('<div class="row"></div>'); }
    var pagebreak = function() { return $('<div class="page-break">&nbsp;</div>'); }
     
    function initUI() {
      $nicuReport.on('input change', update);
      $surgReport.on('input change', update);
      $neodataReport.on('input change', update);
      $nicuReport.focus();
    }

    function update() {
      var nicu = $nicuReport.val(),
          surg = $surgReport.val(),
          neodata = $neodataReport.val();

      if (!(nicu || surg)) {
        $empty.show();
        $processing.hide();
        $roundingData.hide();
        return;
      }

      $empty.hide();
      $processing.show();
      $roundingData.hide();
      
      var nicuData = parseNicu(nicu),
        surgData = parseSurg(surg),
        neodataData = parseNeodata(neodata),
        data = combineData(nicuData, surgData, neodataData); 

      $roundingData.empty();

      for (var i = 0; i < data.length / 4; i++) {
        // Page break before every row after the first page
        if (i > 0) {
          $roundingData.append('<hr>').append(pagebreak());
        }

        var $tableContainer = $(roundingTableTpl()),
            $table = $tableContainer.find('table > tbody').first();
        
        var numCols = 4; 

        for (var j = 0; j < numCols; j++) {
          var idx = i*4+j; 
          if (idx >= data.length) { 
            break; 
          }
          
          var $col = $(roundingColTpl(data[idx])).find('tbody').first();
          t = $table;
          s= $col
          addCol($table, $col);
        }

        if (neodata) {

        }

        $roundingData.append($tableContainer);
      }

      $processing.hide();
      $roundingData.show();
    }

    function parseNicu(text) {
      var parts = text.split('MRN: '),
          dateGroup = text.match(/at *([0-9/]+)/),
          date = dateGroup && dateGroup[1] || undefined,
          data = [], i = 0;

      for (i = 1; i < parts.length; i++) {
        var intRangeRe = [/([0-9]+)\s+([0-9]+)\s*-\s*([0-9]+)/, '$2-$3 ($1)'];

        var name = extractReGroup(parts[i-1], /([a-zA-Z0-9, _/-]*)[\n ]*$/),
            mrn = extractReGroup(parts[i], /^U([0-9]+)/),
            weight = extractReGroup(parts[i], /Weight \(PGC\):\s*([.0-9]+\s*-\s*[0-9\/]+)/i, [/([.0-9]+)\s*-\s*([0-9\/]+)/, '($2) $1']),
            weightKg = weight && extractReGroup(weight, /([.0-9]+)$/),
            calcWeight = extractReGroup(parts[i], /Calc Weight:\s*([.0-9]+)/i),
            medsList = extractReGroup(parts[i], /SCH MEDS\n([\s\S]*?)\nPRN/),
            meds = medsList && medsList.split('\n') || undefined,
            dripsList = extractReGroup(parts[i], /DRIPS\n([\s\S]*?)\n\s*\n/),
            drips = dripsList && dripsList.split('\n') || undefined,
            sups = spliceSups(meds),
            biliMatch = extractReGroup(parts[i], /Labs ([\s\S]*?tb: [0-9.]*)/i),
            biliDate = extractReGroup(biliMatch, /([0-9]+\/[0-9]+ [0-9]+:[0-9]+)/),
            biliVal = extractReGroup(biliMatch, /tb: ([0-9.]*)/i),
            bili = biliVal && ('(' + biliDate + ') ' + biliVal) || undefined,
            giMeds = spliceGIMeds(meds),
            gi = (bili && ('Bili: ' + bili + '<br>') || '') + (giMeds && giMeds.join(', ') || ''),
            neuro = spliceNeuroMeds(meds).concat(spliceNeuroDrips(drips)).join('<br>'),
            cbcMatch = extractReGroup(parts[i], /CBC ([\s\S]*?)(?=Chem7)/i),
            cbc = cbcMatch && cbcMatch
                      .replace(/^.*=([0-9]+\/[0-9]+ [0-9]+:[0-9]+)[\s\S]*?\[([0-9.]+)\][\s\S]*?\[([0-9.]+)\][\s\S]*?\[([0-9.]+)\][\s\S]*?\[([0-9.]+)\][\s\S]*/, 'CBC ($1): WBC $2 Hb $3 Hct $4 Plt $5')
                    || undefined,
            heme = (cbc && (cbc + '<br>') || '') + spliceFe(meds).join(', '),
            chemMatch = extractReGroup(parts[i], /Chem7([\s\S]*?)(?=I\/Os)/i),
            chem = chemMatch && chemMatch
                      .replace(/^.*([0-9]+\/[0-9]+ [0-9]+:[0-9]+) *\n([^\s]+) ([^\s]+) ([^\s]+) *\n([^\s]+) ([^\s]+) ([^\s]+)/, '$1 Na=$2 K=$5 Cl=$3 HCO3=$6 BUN=$4 Cr=$7')
                      .replace(/([0-9]+\/[0-9]+ [0-9]+:[0-9]+)/g, '($1)')
                      .replace(/([0-9]+) +([0-9]+) +([0-9]+) *\n([0-9.]+) +([0-9]+) +([0-9.]+)/, 'Na=$1 K=$4 Cl=$2 HCO3=$5 BUN=$3 Cr=$6')
                      .replace(/Ca[\s\n]*MG[\s\n]*Phos[\s\n]*i-STAT[\s\n]*/i, '')
                      .replace(/Ca[\s\n]*\(Ionized\)[\s\n]*cs[\s\n]*/i, '')
                      .replace(/cs[\s\n]*Lact: ->/i, '')
                      .replace(/Lact: ->/, '')
                    || undefined,
            fio2 = extractReGroup(parts[i], /O2 Percent - Administered:\s*(.*)/, intRangeRe),
            spo2 = extractReGroup(parts[i], /SpO2 %:(.*)/i, intRangeRe),
            rr = extractReGroup(parts[i], /Resp Rate \(br.*?:(.*)/i, intRangeRe),
            hr = extractReGroup(parts[i], /Heart Rate.*?:(.*)/i, intRangeRe),
            map = extractReGroup(parts[i], /MAP Non.*?:(.*)/i, intRangeRe),
            temp = extractReGroup(parts[i], /Temp.*?:(.*)/i, [/([0-9.]+)\s+([0-9.]+)\s*-\s*([0-9.]+)/, '$2-$3 ($1)']),
            abx = spliceAbx(meds),
            ph = extractReGroup(parts[i], /pH by i-STAT.*?:(.*)\n/i, [/([0-9.]+)\s*-\s*(.+)/, '($2) $1']),
            pco2 = extractReGroup(parts[i], /pCO2 by i-STAT.*?:\s*([0-9.]+)/i),
            o2device = extractReGroup(parts[i], /O2 Delivery Device:(.*)/i),
            o2rate = extractReGroup(parts[i], /O2 L\/min:\s*([0-9.]*)/i),
            ventMode = extractReGroup(parts[i], /Ventilation Mode:(.*)/i) || '*',
            ventRate = extractReGroup(parts[i], /AMV Rate:(.*)/i) || '*',
            peep = extractReGroup(parts[i], /PEEP Set:\s*([0-9]*)/i) || '*',
            pip = extractReGroup(parts[i], /PIP:\s*([0-9]*)/i) || '*',
            TVmL = extractReGroup(parts[i], /Tidal Volume - Set:\s*([0-9.]+)/i) || '',
            tv = TVmL && calcWeight && (TVmL + ' (' + (TVmL/calcWeight).toFixed(1) + 'mL/kg)') || TVmL, 
            hfovHz = extractReGroup(parts[i], /HFOV - Hertz:\s*([0-9]*)/i) || '*',
            hfovAmp = extractReGroup(parts[i], /HFOV - Amplitude:\s*([0-9]*)/i) || '*',
            hfovMAP = extractReGroup(parts[i], /HFOV - MAP:\s*([0-9]*)/i) || '*',
            resp = undefined;
        
        if (o2device.match(/Room air/i)) {
          resp = 'RA'
        } else if (ventMode.match(/HFOV/i)) {
          resp = ventMode + ' Hz ' + hfovHz + ' Amp ' + hfovAmp + ' MAP ' + hfovMAP;
        } else if (o2device.match(/Ventilator/i)) {
          resp = ventMode + ' ' + pip + '/' + peep + 'x' + ventRate + (tv && (' TV' + tv) || '');
        } else if (o2device.match(/HIGH Flow Nasal Cannula/i)) {
          resp = 'HFNC ' + o2rate + 'L';
        } else if (o2device.match(/Nasal Cannula/i)) {
          resp = 'NC ' + o2rate + 'L';
        }

        // Remove routine orders, like 1-2-3 paste
        spliceRoutineMeds(meds);
        // Clean redundant words in meds like Neonatal
        cleanMeds(meds);

        pt = {
          name: name, mrn: mrn, date: date,
          weight: weight,
          weightKg: weightKg && parseFloat(weightKg) || undefined,
          calcWeight: calcWeight && parseFloat(calcWeight) || undefined,
          meds: meds, sups: sups, gi: gi,
          heme: heme, chem: chem,
          fio2: fio2, spo2: spo2, rr: rr, hr: hr, map: map, temp: temp,
          abx: abx && abx.join(', ') || undefined,
          gases: ph && (ph + '/' + pco2) || '',
          neuro: neuro,
          resp: resp
        };
        
        data.push(pt);
      }

      return data;
    }

    function extractReGroup(s, regex, replaceSpec) {
      if (!s) { return undefined; }
      
      // Get the first group matched in the regex or undefined
      var match = s.match(regex),
          ret = match && match[1];

      if (replaceSpec && ret) {
        ret = ret.replace(replaceSpec[0], replaceSpec[1]);
      }

      return ret && ret.trim() || undefined;
    }

    function spliceMeds(meds, mapping) {
      if (!Array.isArray(meds)) { return []; }
      var mapped = [];
      for (var i = meds.length-1; i >= 0; i--) {
        for (var m in mapping) {
          if (meds[i].match(mapping[m])) {
            mapped.push(m) && meds.splice(i, 1);
            break;
          }
        }
      }
      return mapped;
    }

    
    function spliceSups(meds) {
      return spliceMeds(meds, {
        'TVS': /Tri-Vi-Sol/i,
        'VitE': /vitamin E/i,
        'VitA': /vitamin A/i,
        'MCT': /MCT oral/i,
        'PVS': /Poly-Vi-Sol/i,
        'NaCl': /• sodium chloride/i,
        'KCl': /potassium chloride/i,
      });
    }
    function spliceFe(meds) {
      return spliceMeds(meds, {
        'Fe': /ferrous sulfate/i,
        'Fe IV': /iron sucrose/i,
      });
    }
    function spliceGIMeds(meds) {
      return spliceMeds(meds, {
        'probiotics': /bifido/i
      });
    }
    function spliceNeuroMeds(meds) {
      var medlist = spliceMeds(meds, {
        'caffeine': /caffeine/i,
      });
      if (Array.isArray(meds)) {
        for (var i = meds.length-1; i >= 0; i--) {
          var morphineMatch = meds[i].match(/morphine\s*-.*?([0-9.]+.*?g).*?(Q[0-9]+)/i);
          if (morphineMatch) {
            medlist.push('morphine (' + morphineMatch[1] + ' ' + morphineMatch[2] + ')');
            meds.splice(i, 1);
          }
        }
      }
      return medlist;
    }
    function spliceNeuroDrips(drips) {
      if (!Array.isArray(drips)) {
        return []; 
      }
      var medlist = [];
      for (var i = drips.length-1; i >= 0; i--) {
        var morphineMatch = drips[i].match(/morphine\s*-\s*([0-9.]*.*?g)/i);
        if (morphineMatch) {
          medlist.push('morphine gtt (' + morphineMatch[1] + ')');
          drips.splice(i, 1);
        }
      }
      return medlist;
    }
    function spliceAbx(meds) {
      return spliceMeds(meds, {
        'amp': /ampicillin/i,
        'gent': /gentamicin/i,
        'meropenem': /meropenem/i,
        'fluconazole': /fluconazole/i,
      });
    }
    function spliceRoutineMeds(meds) {
      return spliceMeds(meds, {
        '1-2-3 paste': /One Two Three/i,
        'hep B': /hepatitis B/i,
      });
    }
    function cleanMeds(meds) {
      if (!Array.isArray(meds)) { return []; }
      for (var i = meds.length-1; i >= 0; i--) {
        meds[i] = meds[i].replace(/- Neonatal /i, '');
      }
    }

    function parseSurg(text) {
      var parts = text.split(/\n(?=U[0-9 ]* DOB)/),
          data = [], i = 0;
      
      for (i = 1; i < parts.length; i++) {
        var name = extractReGroup(parts[i-1], /([a-zA-Z0-9, _/-]*)[\n ]*$/),
            age = extractReGroup(parts[i], /Allergy:.*\n+([0-9]+)-/),
            feeds = extractReGroup(parts[i], /Feeding Orders.(.*)/i),
            ins = extractReGroup(parts[i], /IN: [0-9]+ \⁄ [0-9]+ \⁄ ([0-9]+)/i),
            diet = extractReGroup(parts[i], /Diet: [0-9]+ \⁄ [0-9]+ \⁄ ([0-9]+)/i),
            outs = extractReGroup(parts[i], /OUT: [0-9]+ \⁄ [0-9]+ \⁄ ([0-9]+)/i),
            urine = extractReGroup(parts[i], /GU \/ URINE: [0-9]+ \⁄ [0-9]+ \⁄ ([0-9]+)/i),
            emesis = extractReGroup(parts[i], /Emesis: [0-9]+ \⁄ [0-9]+ \⁄ ([0-9]+)/i);

        feeds = feeds && ('<small>' + feeds.replace(/Neonatal \/ Infant Feeding Diet - (Preterm|Term|Transitional)/i, '') + '</small>') || undefined,
        ins = ins && parseInt(ins) || undefined;
        diet = diet && parseInt(diet) || undefined;
        urine = urine && parseInt(urine) || undefined;
        emesis = emesis && 'em x' || 'No emesis';

        var poPercent = diet && ins && Math.round(diet/ins*100) + '% PO' || 'No PO';

        data.push({
          name: name, age: age,
          feeds: feeds, ins: ins, PO_percent: poPercent,
          urine: urine, emesis: emesis,
        });
      }
      
      return data;
    }

    function parseNeodata(text) {
      var parts = text.split(/\n(?=.*?GAge:)/);
          data = [], i = 0;
      
      for (i = 1; i < parts.length; i++) {
        var mrn = extractReGroup(parts[i], /([0-9]+) On /) || extractReGroup(parts[i], /([0-9]+) *WT:/),
            name = extractReGroup(parts[i], /([A-Z, \(\)_/-]+) [0-9]* *WT:/i),
            age = extractReGroup(parts[i], / AGE:([0-9]+d)/),
            cga = extractReGroup(parts[i], /AdjGA:([0-9]+w[0-9]d)/),
            weight = extractReGroup(parts[i], / WT:([0-9.]+) AGE/);
        
        data.push({
          mrn: mrn, name: name, cga: cga,
          neodataWeight: weight && parseFloat(weight) || undefined, 
        });
      }
      
      return data;
    }

    function combineData(nicuData, surgData, neodataData) {
      var empty = {
            name: "_", date: "_", age: "_", cga: "", weight: "*", TF: "&nbsp;", actual_fluids: "&nbsp;", 
            UOP: "&nbsp;", stools: "&nbsp;", PO_percent: "% PO:", emesis: "_", feeds: "Diet:", sups: "_", 
            chem: "&nbsp;", resp: "_", fio2: "_", rr: "_", spo2: "_", gases: "_", ABCs: "*", 
            gi: "_", hr: "_", map: "_", heme: "_", cbc: "_", temp: "_", abx: "", neuro: "_",
            meds: "_",  
          },
          data = [], pt;

      for (var i in nicuData) {
        var nicuEl = nicuData[i],
            name = nicuEl.name,
            nameRE = new RegExp(name, 'i'),
            surgEl = null, neodataEl = null;

        for (var j in surgData) {
          if (surgData[j].name && nameRE.exec(surgData[j].name)) {
            surgEl = surgData[j];
            continue;
          }
        }

        for (j in neodataData) {
          if (neodataData[j].mrn && neodataData[j].mrn == nicuEl.mrn) {
            neodataEl = neodataData[j];
            continue;
          }
        }

        pt = _.defaults(_.clone(nicuEl), neodataEl);
        pt = _.defaults(pt, surgEl);
        pt = _.defaults(pt, empty);

        pt.weightDiff = pt.weightKg && pt.neodataWeight && ((pt.weightKg - pt.neodataWeight) * 1000).toFixed();  
        pt.meds = Array.isArray(pt.meds) && (pt.meds.length > 0) && pt.meds.join('<br>') || pt.meds;
        pt.sups = Array.isArray(pt.sups) && (pt.sups.length > 0) && pt.sups.join('/') || pt.sups;
        pt.sups = pt.sups && ('+ ' + pt.sups) || pt.sups;
        pt.actual_fluids = pt.ins && pt.calcWeight && (pt.ins / pt.calcWeight).toFixed() || pt.actual_fluids;
        pt.UOP = pt.urine && (pt.urine > 12) && pt.calcWeight && (pt.urine / pt.calcWeight / 24).toFixed(1) || pt.UOP;

        data.push(pt);
      }
      return data;
    }

    function addCol($table, $table2) {
      var rows = $table.children(),
      	  rows2 = $table2.children();
      _.each(rows, function(r, i) {
          if (i < rows2.length) {
            $(r).append($(rows2[i]).children());
          }
      });
    }

    $(function() {
      initUI();
    });
  </script>


</body>

</html>
